<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AR con Botón A-Frame Entity</title>
    
    <!-- A-Frame PRIMERO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.0/aframe.min.js"></script>
    
    <!-- MindAR DESPUÉS de A-Frame -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Botón de respaldo CSS por si acaso */
        #backup-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        #backup-button:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.05);
        }
        
        #status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="ar-container">
        <!-- Botón de respaldo HTML -->
        <button id="backup-button" onclick="handleButtonClick('backup')">
            🔴 BOTÓN RESPALDO
        </button>
        
        <!-- Status info -->
        <div id="status">Inicializando AR...</div>
        
        <!-- A-Frame Scene con MindAR -->
        <a-scene 
            mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/image-tracking/assets/card-example/card.mind; maxTrack: 1; uiLoading: no; uiScanning: no; uiError: no;"
            color-space="sRGB" 
            renderer="colorManagement: true, physicallyCorrectLights" 
            vr-mode-ui="enabled: false" 
            device-orientation-permission-ui="enabled: false">
            
            <!-- Assets -->
            <a-assets>
                <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
            </a-assets>
            
            <!-- Cámara con botón integrado como a-entity -->
            <a-camera 
                position="0 0 0" 
                look-controls="enabled: false" 
                cursor="fuse: false; rayOrigin: mouse;"
                raycaster="far: 10000; objects: .clickable">
                
                <!-- BOTÓN COMO A-ENTITY INTEGRADO EN LA CÁMARA -->
                <a-entity 
                    id="ar-button-entity"
                    geometry="primitive: plane; width: 1.5; height: 0.5"
                    material="color: #ff0000; opacity: 0.9; transparent: true"
                    text="value: 🚀 BOTÓN AR; color: white; align: center; width: 8"
                    position="2 1.5 -3"
                    class="clickable"
                    animation__mouseenter="property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200"
                    animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
                    animation__click="property: material.color; to: #00ff00; startEvents: click; dur: 300">
                </a-entity>
                
                <!-- Botón alternativo en otra posición -->
                <a-entity 
                    id="ar-button-entity-2"
                    geometry="primitive: cylinder; radius: 0.3; height: 0.1"
                    material="color: #0066ff; opacity: 0.9; transparent: true"
                    text="value: CLICK; color: white; align: center; width: 12"
                    position="-2 1.5 -3"
                    class="clickable"
                    animation__hover="property: rotation; to: 0 360 0; startEvents: mouseenter; dur: 1000; loop: true"
                    animation__click="property: material.color; to: #ffff00; startEvents: click; dur: 500">
                </a-entity>
                
            </a-camera>
            
            <!-- Target de imagen para AR -->
            <a-entity mindar-image-target="targetIndex: 0">
                <a-gltf-model 
                    rotation="0 0 0" 
                    position="0 0 0" 
                    scale="0.005 0.005 0.005" 
                    src="#avatarModel">
                </a-gltf-model>
            </a-entity>
            
        </a-scene>
    </div>

    <script>
        // Variables globales
        let arStarted = false;
        let sceneEl = null;
        let cameraEl = null;
        
        // Función para manejar clicks de botones
        function handleButtonClick(source) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] Botón clickeado desde: ${source}`);
            
            // Actualizar status
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `✅ Botón ${source} clickeado a las ${timestamp}`;
            statusEl.style.background = 'rgba(0,255,0,0.7)';
            
            // Ejemplo de acción: cambiar modelo o hacer algo
            alert(`¡Botón ${source} funcionando correctamente!\nHora: ${timestamp}`);
            
            // Restaurar status después de 3 segundos
            setTimeout(() => {
                statusEl.style.background = 'rgba(0,0,0,0.7)';
                statusEl.innerHTML = arStarted ? 'AR activo - Botones funcionando' : 'AR inicializado';
            }, 3000);
        }
        
        // Inicialización cuando A-Frame esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando...');
            
            // Esperar a que A-Frame esté completamente cargado
            setTimeout(() => {
                sceneEl = document.querySelector('a-scene');
                cameraEl = document.querySelector('a-camera');
                
                if (sceneEl && cameraEl) {
                    console.log('A-Frame elementos encontrados');
                    setupAFrameEvents();
                } else {
                    console.warn('No se encontraron elementos A-Frame');
                }
            }, 1000);
        });
        
        function setupAFrameEvents() {
            // Event listener para botones A-Frame
            const arButtons = document.querySelectorAll('#ar-button-entity, #ar-button-entity-2');
            
            arButtons.forEach((button, index) => {
                // Click event
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    handleButtonClick(`A-Frame-${index + 1}`);
                });
                
                // Hover events para debug
                button.addEventListener('mouseenter', function() {
                    console.log(`Hover en botón A-Frame ${index + 1}`);
                });
                
                button.addEventListener('mouseleave', function() {
                    console.log(`Salió hover del botón A-Frame ${index + 1}`);
                });
            });
            
            // Listeners de MindAR
            sceneEl.addEventListener('arReady', function() {
                console.log('MindAR listo');
                document.getElementById('status').innerHTML = 'AR listo - Apunta a una carta';
            });
            
            sceneEl.addEventListener('arError', function(e) {
                console.error('Error en AR:', e);
                document.getElementById('status').innerHTML = '❌ Error en AR';
            });
            
            // Listener para cuando se detecta el target
            const targetEl = document.querySelector('[mindar-image-target]');
            if (targetEl) {
                targetEl.addEventListener('targetFound', function() {
                    console.log('Target encontrado!');
                    arStarted = true;
                    document.getElementById('status').innerHTML = '🎯 Carta detectada - Botones activos';
                });
                
                targetEl.addEventListener('targetLost', function() {
                    console.log('Target perdido');
                    document.getElementById('status').innerHTML = '🔍 Buscando carta...';
                });
            }
            
            console.log('Event listeners configurados');
        }
        
        // Monitor de cambios DOM (por si MindAR modifica algo)
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    // Verificar si los botones A-Frame siguen ahí
                    const arButton = document.getElementById('ar-button-entity');
                    if (!arButton) {
                        console.warn('Botón A-Frame desapareció, puede necesitar recrearse');
                    }
                }
            });
        });
        
        // Observar cambios en el DOM
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Debug: Log cada segundo para verificar estado
        setInterval(() => {
            const arButton = document.getElementById('ar-button-entity');
            const backupButton = document.getElementById('backup-button');
            
            console.log('Estado botones:', {
                aframe: !!arButton,
                backup: !!backupButton,
                arStarted: arStarted
            });
        }, 5000);
    </script>
</body>
</html>
